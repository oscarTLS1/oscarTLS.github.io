<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGROLISTH - Tu Aliado Agrícola Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-image: url('https://img.freepik.com/foto-gratis/campo-trigo_1150-4828.jpg?size=626&ext=jpg&ga=GA1.1.1413502914.1719619200&semt=sph');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* Ensure body itself doesn't cause horizontal scroll */
            overflow-x: hidden;
        }

        /* Custom scrollbar for chat messages and history */
        .chat-messages::-webkit-scrollbar, #conversationHistoryList::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track, #conversationHistoryList::-webkit-scrollbar-track {
            background: #f0fdf4; /* light green */
        }
        .chat-messages::-webkit-scrollbar-thumb, #conversationHistoryList::-webkit-scrollbar-thumb {
            background: #22c55e; /* green-500 */
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover, #conversationHistoryList::-webkit-scrollbar-thumb:hover {
            background: #16a34a; /* green-600 */
        }

        /* Typing indicator animation (dots) */
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
            margin: 0 2px;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        /* Animation for bot message while generating response */
        .generating-animation .dot {
             background-color: #4ade80; /* green-400 for bot message */
        }
        .generating-animation span.generating-text { /* Added class for specific styling */
            font-style: italic;
            color: #52525b; /* zinc-600 */
        }


        /* Markdown styling */
        .bot-message-content p { margin-bottom: 0.5em; word-break: break-word; }
        .bot-message-content ul, .bot-message-content ol { margin-left: 1.25rem; margin-bottom: 0.5em; list-style-position: inside; word-break: break-word; }
        .bot-message-content li { margin-bottom: 0.25em; }
        .bot-message-content strong { color: #16a34a; /* green-600 */ }
        .bot-message-content code { background-color: #e5e7eb; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.9em; word-break: break-all; }
        .bot-message-content a { color: #2563eb; text-decoration: underline; word-break: break-all;}
        .bot-message-content a:hover { color: #1d4ed8; }

        /* Ensure iframe in modal takes full height */
        .modal-body iframe {
            min-height: 70vh;
        }

        /* Animation for message bubbles */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }

        .history-item.active-conversation {
            background-color: #15803d; /* darker green for active */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800 flex items-center justify-center min-h-screen">
    <div class="flex h-screen w-full max-w-7xl shadow-2xl bg-white/80 backdrop-blur-md rounded-lg overflow-hidden">
        <aside id="sidebar" class="bg-gradient-to-b from-green-600 to-green-700 text-white w-64 flex flex-col p-4 transform -translate-x-full md:translate-x-0 md:relative fixed inset-y-0 left-0 z-30 transition-transform duration-300 ease-in-out shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold">AGROLISTH</h1>
                <button id="closeMenuButton" class="md:hidden text-white p-2 rounded-md hover:bg-green-500">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <button id="newConversationButton" class="w-full flex items-center justify-center space-x-2 mb-3 p-2.5 rounded-lg bg-yellow-400 hover:bg-yellow-500 text-green-800 font-semibold transition-colors duration-200 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.056 3 12c0 2.22.784 4.252 2.096 5.842L4.5 21l3.353-1.5A9.002 9.002 0 0012 20.25zM12 8.25v4.5m0 0v4.5m0-4.5h4.5m-4.5 0H7.5" />
                </svg>
                <span>Nueva Conversación</span>
            </button>

            <button id="clearHistoryButton" class="w-full flex items-center justify-center space-x-2 mb-3 p-2.5 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.927a2.25 2.25 0 01-2.244-2.077L4.74 5.929m1.5-.183a2.25 2.25 0 012.244-2.077h.75c.985 0 1.842.572 2.36 1.406l.11.166c.407.603 1.059.95 1.765.95h1.5c.985 0 1.842-.572 2.36-1.406l.11-.166c.407-.603 1.059-.95 1.765-.95h.75c.985 0 1.842-.572 2.36-1.406l.11-.166c.407-.603 1.059-.95 1.765-.95h.75c.985 0 1.842-.572 2.36-1.406z" />
                </svg>
                <span>Borrar Historial</span>
            </button>

            <div id="conversationHistoryContainer" class="flex-grow flex flex-col min-h-0">
                <h3 class="text-xs font-semibold uppercase text-green-300 mb-2 px-1">Historial</h3>
                <div id="conversationHistoryList" class="space-y-1 flex-grow overflow-y-auto pr-1 pb-2">
                    </div>
            </div>

            <nav class="space-y-2 pt-3 border-t border-green-500 mt-2 flex-shrink-0">
                <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="historialPlantaButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                    <span>Historial de la Planta</span>
                </button>
                 <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="recetasCosechaButton">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09L18.75 12l-.813-2.846a4.5 4.5 0 00-3.09-3.09L24 5.25l-.813 2.846a4.5 4.5 0 00-3.09 3.09L17.25 12l2.846.813a4.5 4.5 0 003.09 3.09L24 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L18.25 12zM12 2.25l.813 2.846a4.5 4.5 0 003.09 3.09L18.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09L12 15.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L5.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L12 2.25z" /></svg>
                    <span>Recetas y Usos</span>
                </button>
                <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="optimizacionRecursosButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                    <span>Optimización de Recursos</span>
                </button>
                <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="pricesButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v15c0 .621-.504 1.125-1.125 1.125h-1.5m1.125-1.125a1.125 1.125 0 01-1.125 1.125h-1.5a1.125 1.125 0 01-1.125-1.125M3 3h18M3 9h18M3 15h18" /></svg>
                    <span>Ver Precios Agrícolas</span>
                </button>
                <hr class="border-green-400">
                <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="aboutUsButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                    <span>Acerca de AGROLISTH</span>
                </button>
                <button class="menu-item w-full flex items-center space-x-3 p-3 rounded-lg hover:bg-green-500 hover:shadow-md transition-all duration-200" id="helpButton">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                    <span>Ayuda</span>
                </button>
            </nav>
            <div class="mt-auto pt-4 border-t border-green-500 flex-shrink-0">
                 <a href="https://www.instagram.com/oscar_sierra_2921/" target="_blank" class="flex items-center justify-center space-x-2 p-2 rounded-lg bg-yellow-400 hover:bg-yellow-500 text-green-800 font-semibold transition-colors duration-200 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.85s.012-3.584.07-4.85c.149-3.227 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163m0-1.602C8.734.561 8.316.549 7.053.61c-3.443.158-5.791 2.502-5.95 5.95-.06 1.263-.072 1.68-.072 4.44s.012 3.177.072 4.44c.159 3.448 2.507 5.792 5.95 5.95 1.263.061 1.68.072 4.44.072s3.177-.011 4.44-.072c3.448-.158 5.792-2.502 5.95-5.95.06-1.263.072-1.68.072-4.44s-.012-3.177-.072-4.44c-.158-3.448-2.502-5.792-5.95-5.95C15.684.549 15.266.561 12 .561zm0 5.838a5.602 5.602 0 100 11.204 5.602 5.602 0 000-11.204zm0 9.002a3.402 3.402 0 110-6.804 3.402 3.402 0 010 6.804zm6.406-9.661a1.25 1.25 0 100 2.5 1.25 1.25 0 000-2.5z"></path>
                    </svg>
                    <span>Desarrollador</span>
                </a>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white/90 backdrop-blur-sm p-4 shadow-md flex items-center justify-between flex-shrink-0">
                <div class="flex items-center">
                    <button id="openMenuButton" class="md:hidden text-green-600 p-2 rounded-md hover:bg-green-100 mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-green-600 mr-2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.342c.875.342 1.816.533 2.805.533 4.235 0 7.673-3.206 7.673-7.175 0-3.97-3.438-7.175-7.673-7.175S4.327 7.73 4.327 11.7c0 1.81.706 3.469 1.855 4.728M12 18.342V21m0-2.658a21.513 21.513 0 00-9.435-5.083M12 18.342a21.513 21.513 0 019.435-5.083M9.75 11.7a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0z" />
                        </svg>
                        <h2 class="text-xl font-semibold text-green-700">Agrochat</h2>
                    </div>
                </div>
                <div id="typingIndicator" class="text-sm text-green-600 flex items-center opacity-0 transition-opacity duration-300">
                    <span class="mr-1">Agrochat está activo</span>
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </div>
            </header>

            <div id="chatMessages" class="flex-1 p-4 md:p-6 space-y-4 overflow-y-auto bg-green-50/50 chat-messages">
                </div>

            <div class="bg-white p-3 md:p-4 border-t border-gray-200 shadow-md flex-shrink-0">
                <div class="flex items-end space-x-2">
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                    <input type="file" id="cameraInput" accept="image/*" capture="camera" class="hidden">

                    <button id="uploadImageButton" title="Subir foto de la galería" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-100 rounded-full transition-colors flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                    </button>
                    <button id="takePictureButton" title="Tomar foto con cámara" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-100 rounded-full transition-colors flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                    </button>
                    <textarea id="userInput" placeholder="Escribe tu mensaje o pregunta aquí..." rows="1" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none outline-none transition-all min-w-0 max-h-32"></textarea>
                    <button id="sendMessageButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-5 rounded-lg shadow hover:shadow-md transition-all duration-200 flex items-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                        
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="pricesModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-40 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                <h3 class="text-lg font-semibold text-green-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v15c0 .621-.504 1.125-1.125 1.125h-1.5m1.125-1.125a1.125 1.125 0 01-1.125 1.125h-1.5a1.125 1.125 0 01-1.125-1.125M3 3h18M3 9h18M3 15h18" /></svg>
                    Precios Agrícolas Corabastos
                </h3>
                <button id="closePricesModal" class="text-gray-500 hover:text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="modal-body p-1 flex-grow overflow-y-auto">
                <iframe src="https://corabastos.com.co/boletin-de-precios/" width="100%" class="h-full block" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // API Configuration
        const apiKey = "AIzaSyBzGvM2L1t0LC1cqQFK_mVixhCvW0Zwq3M"; // IMPORTANT: Replace with your actual API Key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        const MAX_IMAGE_SIZE_MB = 6;

        // DOM Elements
        const chatMessagesEl = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const uploadImageButton = document.getElementById('uploadImageButton');
        const imageUploadInput = document.getElementById('imageUpload');
        // Corrected: takePictureButton should refer to the button element, not the input
        const takePictureButton = document.getElementById('takePictureButton'); 
        const cameraInput = document.getElementById('cameraInput'); // This correctly refers to the hidden input
        const typingIndicator = document.getElementById('typingIndicator');
        
        const sidebar = document.getElementById('sidebar');
        const openMenuButton = document.getElementById('openMenuButton');
        const closeMenuButton = document.getElementById('closeMenuButton');
        const newConversationButton = document.getElementById('newConversationButton');
        const conversationHistoryListEl = document.getElementById('conversationHistoryList');
        const clearHistoryButton = document.getElementById('clearHistoryButton'); 

        const historialPlantaButton = document.getElementById('historialPlantaButton');
        const recetasCosechaButton = document.getElementById('recetasCosechaButton');
        const optimizacionRecursosButton = document.getElementById('optimizacionRecursosButton');
        const pricesButton = document.getElementById('pricesButton');
        const aboutUsButton = document.getElementById('aboutUsButton');
        const helpButton = document.getElementById('helpButton');
        
        const pricesModal = document.getElementById('pricesModal');
        const closePricesModalButton = document.getElementById('closePricesModal');

        let currentChatHistory = []; 
        let allConversations = []; 
        let currentConversationId = null;
        let conversationCounter = 0; 

        /**
         * Toggles the visibility of the sidebar.
         */
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }

        // Event listeners for opening and closing the sidebar
        openMenuButton.addEventListener('click', toggleSidebar);
        closeMenuButton.addEventListener('click', toggleSidebar);

        // Close sidebar when a menu item or new conversation button is clicked on small screens
        document.querySelectorAll('#sidebar .menu-item, #sidebar #newConversationButton').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth < 768) { // md breakpoint in Tailwind is 768px
                    toggleSidebar();
                }
            });
        });
        
        /**
         * Shows or hides the typing indicator in the header.
         * @param {boolean} isActive - True to show, false to hide.
         * @param {string} message - The message to display (e.g., "Agrochat está activo").
         */
        function showTypingIndicatorHeader(isActive, message = "Agrochat está activo") {
            typingIndicator.querySelector('span:first-child').textContent = message;
            if (isActive) {
                typingIndicator.classList.remove('opacity-0');
            } else {
                typingIndicator.classList.add('opacity-0');
            }
        }
        
        /**
         * Adds a message bubble to the chat UI.
         * @param {string} sender - 'user' or 'bot'.
         * @param {string} text - The message text.
         * @param {string|null} imagePreviewUrl - URL for image preview if applicable.
         * @param {boolean} isGenerating - True if this is a placeholder for a generating bot response.
         * @param {string|null} quickActionsHtml - HTML string for quick action buttons, if applicable.
         * @returns {string|null} - A unique ID for generating messages, or null.
         */
        function addMessageToUI(sender, text, imagePreviewUrl = null, isGenerating = false, quickActionsHtml = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message', `${sender}-message`, 'flex', 'items-end', 'animate-fade-in-up');
            if (isGenerating) {
                messageWrapper.dataset.generatingId = Date.now(); // Unique ID for updating
            }

            const avatar = document.createElement('div');
            avatar.classList.add('flex-shrink-0', 'mb-1');
            const avatarSpan = document.createElement('span');
            avatarSpan.classList.add('block', 'w-8', 'h-8', 'rounded-full', 'flex', 'items-center', 'justify-center', 'text-sm', 'font-bold');

            const messageBubble = document.createElement('div');
            messageBubble.classList.add('p-3', 'rounded-lg', 'shadow', 'max-w-xl', 'md:max-w-2xl'); // Added md:max-w-2xl for wider screens

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                avatar.classList.add('ml-2', 'order-2');
                avatarSpan.classList.add('bg-blue-500', 'text-white');
                avatarSpan.textContent = 'TÚ';
                messageBubble.classList.add('bg-blue-500', 'text-white', 'order-1');
            } else { 
                messageWrapper.classList.add('justify-start');
                avatar.classList.add('mr-2');
                avatarSpan.classList.add('bg-green-500', 'text-white');
                avatarSpan.textContent = 'AG'; // Agrochat avatar
                messageBubble.classList.add('bg-white', 'text-gray-800', 'bot-message-content');
            }
            
            avatar.appendChild(avatarSpan);

            if (imagePreviewUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = imagePreviewUrl;
                imgElement.classList.add('rounded-md', 'max-w-xs', 'mb-2', 'shadow-sm');
                messageBubble.appendChild(imgElement);
            }

            const textContentDiv = document.createElement('div');
            if (isGenerating) {
                // Display a typing indicator while generating
                textContentDiv.classList.add('generating-animation', 'flex', 'items-center', 'space-x-1', 'p-1');
                textContentDiv.innerHTML = `
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    <span class="text-sm text-gray-500 generating-text">Generando respuesta...</span>`;
            } else {
                 textContentDiv.innerHTML = marked.parse(text); // Parse markdown
            }
            messageBubble.appendChild(textContentDiv);

            // Append quick action buttons if provided and it's a bot message
            if (quickActionsHtml && sender === 'bot') {
                messageBubble.insertAdjacentHTML('beforeend', quickActionsHtml);
            }
            
            messageWrapper.appendChild(messageBubble);
            messageWrapper.appendChild(avatar);

            chatMessagesEl.appendChild(messageWrapper);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; // Scroll to bottom
            return messageWrapper.dataset.generatingId; // Return ID for future updates
        }
        
        /**
         * Updates a generating bot message with the final AI response.
         * @param {string} generatingId - The ID of the message to update.
         * @param {string} newText - The final text from the AI.
         */
        function updateGeneratingMessageInUI(generatingId, newText) {
            const generatingMessageWrapper = chatMessagesEl.querySelector(`[data-generating-id="${generatingId}"]`);
            if (generatingMessageWrapper) {
                const bubbleContent = generatingMessageWrapper.querySelector('.bot-message-content');
                if (bubbleContent) {
                    const textContentDiv = bubbleContent.querySelector('.generating-animation') || document.createElement('div');
                    // Remove generating animation classes and set final content
                    textContentDiv.classList.remove('generating-animation', 'flex', 'items-center', 'space-x-1', 'p-1');
                    textContentDiv.innerHTML = marked.parse(newText);
                    // If it was a new div, append it. If it was the animation div, its content is replaced.
                    if (!bubbleContent.contains(textContentDiv)) {
                         bubbleContent.innerHTML = ''; // Clear if it was just animation
                         bubbleContent.appendChild(textContentDiv);
                    }
                }
            }
        }

        // Auto-resize textarea based on content
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
        });
        // Set initial max-height for textarea via JS if not in CSS, or ensure CSS is present
        // Tailwind class max-h-32 is already applied in HTML

        /**
         * Generates a title for a conversation based on its messages.
         * @param {Array<Object>} messages - The array of message objects.
         * @returns {string} The generated title.
         */
        function generateConversationTitle(messages) {
            if (!messages || messages.length === 0) return "Nueva Conversación";
            const firstUserMessage = messages.find(msg => msg.role === 'user');
            let title = firstUserMessage ? (firstUserMessage.parts.find(p=>p.text)?.text || "").substring(0, 25) : "Conversación";
            if (firstUserMessage && (firstUserMessage.parts.find(p=>p.text)?.text || "").length > 25) title += "...";
            return title || `Conversación ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        /**
         * Renders the list of conversations in the sidebar.
         */
        function renderConversationList() {
            conversationHistoryListEl.innerHTML = '';
            // Sort conversations by last message timestamp (newest first)
             const sortedConversations = [...allConversations].sort((a, b) => {
                const timeA = a.lastUpdated || 0;
                const timeB = b.lastUpdated || 0;
                return timeB - timeA;
            });

            sortedConversations.forEach(conv => {
                const button = document.createElement('button');
                button.classList.add('history-item', 'w-full', 'text-left', 'text-sm', 'p-2', 'rounded-md', 'hover:bg-green-500', 'truncate', 'transition-colors');
                if (conv.id === currentConversationId) {
                    button.classList.add('active-conversation');
                }
                button.textContent = conv.title;
                button.dataset.id = conv.id;
                button.addEventListener('click', () => loadConversation(conv.id));
                conversationHistoryListEl.appendChild(button);
            });
        }

        /**
         * Saves the current conversation to local storage.
         */
        function saveCurrentConversation() {
            if (currentChatHistory.length === 0 && !currentConversationId) return; 

            const title = generateConversationTitle(currentChatHistory);
            const timestamp = Date.now(); // Add timestamp for sorting
            
            // Add timestamp to the last message if it doesn't have one
            if(currentChatHistory.length > 0) {
                const lastMessage = currentChatHistory[currentChatHistory.length - 1];
                if(!lastMessage.timestamp) lastMessage.timestamp = timestamp;
            }

            if (currentConversationId) {
                const existingConvIndex = allConversations.findIndex(c => c.id === currentConversationId);
                if (existingConvIndex > -1) {
                    allConversations[existingConvIndex].messages = [...currentChatHistory];
                    allConversations[existingConvIndex].title = title; 
                    allConversations[existingConvIndex].lastUpdated = timestamp;
                } else { 
                    // This case implies currentConversationId was set but not found in allConversations
                    // which might happen if allConversations was cleared or an ID mismatch.
                    // Treat as new if not found, or re-evaluate ID generation.
                    const newId = `conv-${++conversationCounter}-${timestamp}`;
                    allConversations.push({ id: newId, title, messages: [...currentChatHistory], lastUpdated: timestamp });
                    currentConversationId = newId; // Update current ID to the new one
                }
            } else if (currentChatHistory.length > 0) { 
                currentConversationId = `conv-${++conversationCounter}-${timestamp}`;
                allConversations.push({ id: currentConversationId, title, messages: [...currentChatHistory], lastUpdated: timestamp });
            }
            
            localStorage.setItem('agrolisthAllConversations', JSON.stringify(allConversations));
            if(currentConversationId) localStorage.setItem('agrolisthLastConversationId', currentConversationId);
            renderConversationList();
        }
        
        /**
         * Loads the initial bot message into the chat UI.
         */
        function loadInitialBotMessage() {
            const initialMsgText = "¡Hola! Soy Agrochat, tu asistente virtual para el campo. ¿En qué puedo ayudarte hoy?";
            const quickActionsHtml = `
                <div class="mt-3 space-y-1 md:space-y-0 md:space-x-2 flex flex-col md:flex-row flex-wrap">
                    <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="¿Cómo puedo mejorar la productividad de mi cultivo?">Mejorar productividad</button>
                    <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="¿Qué plagas afectan el tomate?">Plagas de tomate</button>
                    <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="Necesito información sobre fertilizantes.">Fertilizantes</button>
                </div>`;
            // Pass quickActionsHtml as a separate parameter
            addMessageToUI('bot', initialMsgText, null, false, quickActionsHtml);
            currentChatHistory.push({ role: 'model', parts: [{ text: initialMsgText }], timestamp: Date.now() }); 
            addQuickActionListeners(); // Attach listeners to newly added quick actions
        }

        /**
         * Starts a new conversation, saving the current one if active.
         */
        function startNewConversation() {
            saveCurrentConversation(); // Save the current conversation before starting a new one
            
            currentChatHistory = []; // Clear chat history
            currentConversationId = null; // Reset current conversation ID
            chatMessagesEl.innerHTML = ''; // Clear chat UI
            
            loadInitialBotMessage(); // Load the welcome message
            renderConversationList(); // Update history list
            userInput.focus(); // Focus on input field
        }
        
        newConversationButton.addEventListener('click', startNewConversation);

        /**
         * Clears all conversations from local storage and resets the chat.
         */
        function clearAllConversations() {
            localStorage.removeItem('agrolisthAllConversations');
            localStorage.removeItem('agrolisthLastConversationId');
            allConversations = [];
            currentChatHistory = [];
            currentConversationId = null;
            conversationCounter = 0;
            chatMessagesEl.innerHTML = ''; // Clear chat UI
            loadInitialBotMessage(); // Load the welcome message
            renderConversationList(); // Update history list
            userInput.focus(); // Focus on input field
        }

        // Add event listener for the new button
        clearHistoryButton.addEventListener('click', clearAllConversations);

        /**
         * Loads a specific conversation from history into the chat UI.
         * @param {string} conversationId - The ID of the conversation to load.
         */
        function loadConversation(conversationId) {
            if (currentConversationId === conversationId && chatMessagesEl.children.length > 0) return; // Already loaded

            saveCurrentConversation(); // Save current conversation before loading a new one

            const conversationToLoad = allConversations.find(c => c.id === conversationId);
            if (conversationToLoad) {
                currentConversationId = conversationId;
                currentChatHistory = [...conversationToLoad.messages];
                chatMessagesEl.innerHTML = ''; // Clear current chat UI
                currentChatHistory.forEach(msg => {
                    const textPart = msg.parts.find(p => p.text)?.text || "";
                    // Image previews are not re-rendered from history for now to simplify
                    // When loading from history, quick actions are re-added separately below if it's the initial message.
                    addMessageToUI(msg.role === 'model' ? 'bot' : 'user', textPart);
                });
                
                // Re-add quick actions if the last message was the initial bot message
                const lastMsg = currentChatHistory[currentChatHistory.length -1];
                if (lastMsg && lastMsg.role === 'model' && lastMsg.parts[0].text.startsWith("¡Hola! Soy Agrochat")) {
                     const lastBotMessageBubble = chatMessagesEl.querySelector('.bot-message:last-child .bot-message-content');
                    if (lastBotMessageBubble && !lastBotMessageBubble.querySelector('.quick-action-btn')) {
                        const quickActionsHtml = `
                            <div class="mt-3 space-y-1 md:space-y-0 md:space-x-2 flex flex-col md:flex-row flex-wrap">
                                <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="¿Cómo puedo mejorar la productividad de mi cultivo?">Mejorar productividad</button>
                                <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="¿Qué plagas afectan el tomate?">Plagas de tomate</button>
                                <button class="quick-action-btn bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1.5 rounded-full text-sm transition-colors grow md:grow-0" data-question="Necesito información sobre fertilizantes.">Fertilizantes</button>
                            </div>`;
                        lastBotMessageBubble.insertAdjacentHTML('beforeend', quickActionsHtml);
                    }
                }
                addQuickActionListeners(); // Ensure listeners are active for any loaded content
            }
            renderConversationList(); // Re-render to highlight active conversation
        }
        
        /**
         * Loads all conversations from local storage and initializes the chat.
         */
        function loadConversationsFromStorage() {
            const storedConversations = localStorage.getItem('agrolisthAllConversations');
            const lastConvId = localStorage.getItem('agrolisthLastConversationId');
            if (storedConversations) {
                allConversations = JSON.parse(storedConversations);
                // Find the highest counter from existing IDs to ensure unique new IDs
                let maxCounter = 0;
                allConversations.forEach(c => {
                    const idParts = c.id.split('-');
                    if (idParts.length > 1 && !isNaN(parseInt(idParts[1]))) {
                        maxCounter = Math.max(maxCounter, parseInt(idParts[1]));
                    }
                });
                conversationCounter = maxCounter;
            }

            if (lastConvId && allConversations.some(c => c.id === lastConvId)) {
                loadConversation(lastConvId);
            } else if (allConversations.length > 0) {
                // If no last conversation ID, load the most recent one
                const mostRecentConv = [...allConversations].sort((a,b) => (b.lastUpdated || 0) - (a.lastUpdated || 0))[0];
                loadConversation(mostRecentConv.id);
            }
            else {
                // If no conversations, start a new one
                startNewConversation(); 
            }
            renderConversationList();
        }

        /**
         * Sends the user's prompt to the AI model and handles the response.
         * @param {Array<Object>} promptParts - The parts of the prompt (text and/or image data).
         */
        async function sendMessageToAI(promptParts) { 
            showTypingIndicatorHeader(true, "Agrochat está procesando");
            const generatingId = addMessageToUI('bot', '', null, true); // Add a placeholder message

            const requestBody = {
                contents: [],
                generationConfig: {
                    "maxOutputTokens": 1024, "temperature": 0.7, "topP": 0.95, "topK": 40
                },
                safetySettings: [
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }
                ]
            };

            // Prepare history for API: map currentChatHistory to the expected format
            // Only include 'text' or 'inlineData' as per Gemini spec. Do not send 'timestamp'.
            const historyForAPI = currentChatHistory.map(msg => ({
                role: msg.role, // 'user' or 'model'
                parts: msg.parts.map(part => {
                    if (part.text) return { text: part.text };
                    if (part.inlineData) return { inlineData: part.inlineData };
                    return {}; // Should not happen if parts are structured correctly
                }).filter(p => Object.keys(p).length > 0) // Filter out empty parts
            })).slice(-10); // Send last 10 exchanges (user + model) to keep context manageable

            requestBody.contents = [...historyForAPI, { role: "user", parts: promptParts }];

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                let aiResponseText = "No pude generar una respuesta. Intenta de nuevo.";
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    aiResponseText = `Disculpa, hubo un problema: ${errorData.error?.message || 'Error desconocido'}.`;
                    if (response.status === 503 || errorData.error?.message.includes("overloaded")) {
                        aiResponseText = "Servicio con alta demanda. Intenta en unos momentos.";
                    }
                } else {
                    const data = await response.json();
                    console.log("AI Response:", data);
                    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                        aiResponseText = data.candidates[0].content.parts[0].text;
                    } else if (data.promptFeedback?.blockReason) {
                        aiResponseText = `Solicitud bloqueada: ${data.promptFeedback.blockReason}. Reformula tu pregunta.`;
                    }
                }
                
                updateGeneratingMessageInUI(generatingId, aiResponseText); // Update the placeholder with actual response
                currentChatHistory.push({ role: 'model', parts: [{ text: aiResponseText }], timestamp: Date.now() });
                saveCurrentConversation(); // Save conversation after bot response

            } catch (error) {
                console.error("Error al comunicarse con la IA:", error);
                updateGeneratingMessageInUI(generatingId, `Error de conexión: ${error.message}. Verifica e intenta.`);
                currentChatHistory.push({ role: 'model', parts: [{ text: `Error de conexión: ${error.message}` }], timestamp: Date.now() }); 
                saveCurrentConversation();
            } finally {
                showTypingIndicatorHeader(false); // Hide typing indicator
            }
        }

        /**
         * Processes an image file (from upload or camera) and sends it to the AI.
         * @param {File} file - The image file to process.
         */
        function processImageFile(file) {
            if (file) {
                if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
                    addMessageToUI('bot', `La imagen es demasiado grande (máx ${MAX_IMAGE_SIZE_MB}MB).`);
                    imageUploadInput.value = ''; cameraInput.value = ''; // Clear input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Image = e.target.result.split(',')[1];
                    const imagePreviewUrl = e.target.result;
                    const userPromptText = "Analiza esta imagen de mi planta y dime su estado, posibles problemas o necesidades. Si es una plaga o enfermedad, identifícala y sugiere tratamientos. Si es un cultivo, indica qué tipo de cultivo podría ser.";
                    
                    addMessageToUI('user', userPromptText, imagePreviewUrl); // Display user message with image
                    const userMessageParts = [
                        { text: userPromptText },
                        { inlineData: { mimeType: file.type || "image/jpeg", data: base64Image } }
                    ];
                    currentChatHistory.push({ role: 'user', parts: userMessageParts, timestamp: Date.now() });
                    saveCurrentConversation();
                    
                    sendMessageToAI(userMessageParts); // Send to AI
                    imageUploadInput.value = ''; cameraInput.value = ''; // Clear input
                };
                reader.onerror = () => addMessageToUI('bot', 'Error al leer el archivo de imagen.');
                reader.readAsDataURL(file);
            }
        }

        // Event listeners for image upload and camera input
        uploadImageButton.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', (event) => processImageFile(event.target.files[0]));
        takePictureButton.addEventListener('click', () => cameraInput.click());
        cameraInput.addEventListener('change', (event) => processImageFile(event.target.files[0]));

        /**
         * Handles sending a text message to the AI.
         */
        function handleSendMessage() {
            const messageText = userInput.value.trim();
            if (messageText) {
                addMessageToUI('user', messageText); // Display user message
                const userMessageParts = [{ text: messageText }];
                currentChatHistory.push({ role: 'user', parts: userMessageParts, timestamp: Date.now() });
                saveCurrentConversation(); // Save conversation after user message
                sendMessageToAI(userMessageParts); // Send to AI
                userInput.value = ''; // Clear input
                userInput.style.height = 'auto'; // Reset textarea height
            }
        }

        // Event listeners for sending messages
        sendMessageButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter, new line on Shift + Enter
                e.preventDefault();
                handleSendMessage();
            }
        });
        
        /**
         * Attaches event listeners to quick action buttons.
         */
        function addQuickActionListeners() {
            const quickButtons = document.querySelectorAll('.quick-action-btn');
            quickButtons.forEach(button => {
                // Clone and replace to remove old listeners effectively to prevent multiple listeners
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', () => {
                    const question = newButton.dataset.question;
                    userInput.value = question; // Populate input with quick action question
                    handleSendMessage(); // Send the message
                });
            });
        }
        // Initial call to attach listeners to any pre-existing quick action buttons (e.g. from initial message)
        addQuickActionListeners();


        // Event listeners for prices modal
        pricesButton.addEventListener('click', () => {
            pricesModal.classList.remove('hidden');
            if (window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
        });
        closePricesModalButton.addEventListener('click', () => pricesModal.classList.add('hidden'));
        pricesModal.addEventListener('click', (event) => {
            if (event.target === pricesModal) pricesModal.classList.add('hidden'); // Close if clicked outside
        });

        /**
         * Handles actions triggered by menu items (e.g., Planificador de Cultivos, Ayuda).
         * @param {string} promptStart - The main text for the bot's response.
         * @param {string} additionalInfo - Additional information to append to the bot's response.
         */
        function handleMenuAction(promptStart, additionalInfo = "") {
            const fullBotMessage = promptStart + (additionalInfo ? `\n\n${additionalInfo}` : '');
            addMessageToUI('bot', fullBotMessage); // Display bot's response
            currentChatHistory.push({ role: 'model', parts: [{ text: fullBotMessage }], timestamp: Date.now() });
            saveCurrentConversation(); // Save conversation
            if (window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
        }
        
        // Event listeners for sidebar menu items
        historialPlantaButton.addEventListener('click', () => handleMenuAction(
            "¡Llevar un historial de tus plantas es muy útil!",
            "Por ahora, te sugiero que me envíes fotos de tus plantas periódicamente con una pequeña descripción (ej. 'Foto del día 10 de mi cultivo de frijol, las hojas se ven amarillas'). Yo puedo analizar cada foto y, con el tiempo, podrías armar un 'diario visual' de su salud."
        ));
        recetasCosechaButton.addEventListener('click', () => handleMenuAction(
            "¿Tienes una cosecha abundante y no sabes qué hacer con ella?",
            "Dime **qué producto tienes** (ej. plátano, yuca, mango) y te sugeriré recetas, métodos de conservación o ideas para darle valor agregado."
        ));
        optimizacionRecursosButton.addEventListener('click', () => handleMenuAction(
            "¡Optimizar el uso de agua y energía es clave!",
            "Pregúntame sobre:\n* **Riego:** '¿Cómo riego mis cultivos de forma más eficiente?'\n* **Energía:** '¿Cómo puedo usar paneles solares en mi finca?'\n\nDame detalles sobre tu situación."
        ));
        aboutUsButton.addEventListener('click', () => handleMenuAction(
            "Somos **AGROLISTH**, tu asistente inteligente para el campo.",
            "Estamos aquí para ayudarte a mejorar tus cultivos, identificar problemas y ofrecerte información valiosa para una agricultura más eficiente y sostenible."
        ));
        helpButton.addEventListener('click', () => handleMenuAction(
            "**¡Claro!** Puedes preguntarme sobre:",
            "* **Diagnóstico de plantas:** 'Mi tomate tiene manchas...' (¡Sube una foto!)\n" +
            "* **Planificador de Cultivos:** 'Quiero plantar maíz...'\n" +
            "* **Historial de la Planta:** '¿Cómo llevo seguimiento...?'\n" +
            "* **Recetas y Usos:** 'Tengo mucha guayaba...'\n" +
            "* **Optimización de Recursos:** '¿Cómo reducir consumo de agua...?'\n" +
            "* **Fertilización, Riego, Clima...** ¡y más!"
        ));

        // Load conversations and initialize chat on page load
        loadConversationsFromStorage();
        // Ensure quick action listeners are attached after initial load/new conversation setup
        if (chatMessagesEl.querySelector('.quick-action-btn')) {
            addQuickActionListeners();
        }
    });
    </script>
</body>
</html>
